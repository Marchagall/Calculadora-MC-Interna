<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculadora de Precio de Fotos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    .calculator {
      width: 700px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.1);
      background-color: #f9f9f9;
      box-sizing: border-box;
      text-align: center;
      margin: auto;
    }
    .size {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 20px;
    }
    .quantity-container {
      justify-content: right;
      align-items: center;
      text-align: right;
    }
    .quantity-button {
      width: 35px;
      height: 35px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .quantity-input {
      width: 50px;
      padding: 9px;
      margin: 0 1px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button:hover {
      background-color: #45a049;
    }
    .total-price-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 10px;
      font-size: 10px;
    }
    .total-price-label {
      font-size: 25px;
      margin-right: 10px;
    }
    .total-price-value {
      font-size: 20px;
      text-align: right;
    }
    .total-per-size {
      font-size: 26px;
      color: black;
      width: 10%;
      text-align: center;
      margin-bottom: 5px;
    }
    .button-container {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    .button-container button {
      padding: 8px 16px;
      border: none;
      background-color: #4CAF50;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }
    hr {
      border: 1px solid;
      margin: 2px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    .main-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    .summary {
      width: 700px;
      background-color: #ffffff;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.1);
    }
    .summary table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
	  text-align: center;
    }
    .summary th,
    .summary td {
      padding: 6px;
      border: 1px solid #ddd;
      text-align: center;
    }
    .summary button {
      margin-top: 10px;
      margin-right: 5px;
      padding: 6px 12px;
      font-size: 14px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .summary button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>

<div class="main-container">
  <div class="summary">
    <h3>Resumen de Operaciones</h3>
    <table id="recordTable">
      <thead>
        <tr>
          <th>Tamaño</th>
          <th>Cantidad</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <br>
    <button onclick="downloadXLSX()">Descargar XLSX</button>
  </div>

  <div class="calculator">
    <div class="button-container">
      <button onclick="resetInputs()">Reset</button>
    </div>
    <hr>
    <div id="sizes"></div>
    <hr>
    <div class="total-price-container">
      <label for="totalPrice" class="total-price-label">Total:</label>
      <span id="totalPrice" class="total-price-value">$0</span>
      &nbsp;<span>|</span>
      <input type="checkbox" id="applyInterest" onchange="calculateTotal();">
      <label for="applyInterest">Precio Tarjeta hasta 3 cuotas</label>
    </div>
  </div>
</div>

<script>
  const sizes = [
    { size: "9x13", price: 600 },
    { size: "10x15", price: 700 },
    { size: "13x18", price: 800 },
    { size: "15x21", price: 900 },
    { size: "20x30", price: 2500 },
    { size: "30x40", price: 4500 },
    { size: "9x13 Pro", price: 500 },
    { size: "10x15 Pro", price: 600 },
    { size: "13x18 Pro", price: 700 },
    { size: "15x21 Pro", price: 800 },
    { size: "20x30 Pro", price: 2200 },
    { size: "30x40 Pro", price: 4000 },
    { size: "Digitalizado", price: 1000 },
    { size: "Hora de Arte", price: 5000 },
    { size: "Revelado", price: 25000 }
  ];

  const defaultPrices = sizes.map(s => s.price);
  let customPrices = [...defaultPrices];
  let summaryData = [];
  let lastAddedQuantities = new Array(sizes.length).fill(0);
  const interestCheckbox = document.getElementById("applyInterest");

  const sizesContainer = document.getElementById('sizes');
  sizes.forEach((size, i) => {
    const div = document.createElement('div');
    div.classList.add('size');
    div.innerHTML = `
      <span class="total-per-size" id="totalPerSize${i+1}">$0</span>
      <label>${size.size} - $${formatPrice(size.price)}</label>
      <div class="quantity-container">
        <button class="quantity-button" onclick="decrementQuantity(${i+1})">-</button>
        <input type="text" id="quantity${i+1}" class="quantity-input" value="0" onkeypress="handleKeyPress(event, ${i+1})" onfocus="if(this.value === '0') this.value = ''" onblur="if(this.value === '') this.value = '0'">
        <button class="quantity-button" onclick="incrementQuantity(${i+1})">+</button>
      </div>
    `;
    sizesContainer.appendChild(div);
    if (i < sizes.length - 1) sizesContainer.appendChild(document.createElement('hr'));
  });

  function incrementQuantity(index) {
  const input = document.getElementById("quantity" + index);
  const newQty = parseInt(input.value || 0) + 1;
  input.value = newQty;

  const sizeIndex = index - 1;
  const sizeInfo = sizes[sizeIndex];
  const deltaQty = newQty - lastAddedQuantities[sizeIndex];
  const price = interestCheckbox.checked ? customPrices[sizeIndex] * 1.4 : customPrices[sizeIndex];
  const deltaTotal = deltaQty * price;

  const existingIndex = summaryData.findIndex(item => item.size === sizeInfo.size);
  if (existingIndex !== -1) {
    summaryData[existingIndex].quantity += deltaQty;
    summaryData[existingIndex].total += deltaTotal;
  } else {
    summaryData.push({
      size: sizeInfo.size,
      quantity: deltaQty,
      total: deltaTotal
    });
  }

  lastAddedQuantities[sizeIndex] = newQty;

  calculateTotal();
  calculateTotalPerSize(index);
  reloadSummaryTable();
}


  function decrementQuantity(index) {
  const input = document.getElementById("quantity" + index);
  const currentQty = parseInt(input.value || 0);
  if (currentQty > 0) {
    const newQty = currentQty - 1;
    input.value = newQty;

    const sizeIndex = index - 1;
    const sizeInfo = sizes[sizeIndex];
    const deltaQty = newQty - lastAddedQuantities[sizeIndex];
    const price = interestCheckbox.checked ? customPrices[sizeIndex] * 1.4 : customPrices[sizeIndex];
    const deltaTotal = Math.abs(deltaQty) * price;

    // Update summaryData
    const existingIndex = summaryData.findIndex(item => item.size === sizeInfo.size);
    if (existingIndex !== -1) {
      summaryData[existingIndex].quantity += deltaQty;
      summaryData[existingIndex].total += deltaQty * price;

      // Remove the entry if quantity goes to 0 or below
      if (summaryData[existingIndex].quantity <= 0) {
        summaryData.splice(existingIndex, 1);
      }
    }

    // Update lastAddedQuantities
    lastAddedQuantities[sizeIndex] = newQty;

    calculateTotal();
    calculateTotalPerSize(index);
    reloadSummaryTable();
  }
}


  function handleKeyPress(e, index) {
    if (e.keyCode === 13) {
      const input = document.getElementById("quantity" + index);
      input.value = Math.max(0, parseInt(input.value || 0));
      calculateTotal();
      calculateTotalPerSize(index);
      updateLiveSummary();
    }
  }

  function calculateTotal() {
    let total = 0;
    sizes.forEach((s, i) => {
      const qty = parseInt(document.getElementById("quantity" + (i + 1)).value || 0);
      const price = interestCheckbox.checked ? customPrices[i] * 1.4 : customPrices[i];
      total += qty * price;
    });
    document.getElementById("totalPrice").textContent = "$" + formatPrice(total);
  }

  function calculateTotalPerSize(index) {
    const qty = parseInt(document.getElementById("quantity" + index).value || 0);
    const price = interestCheckbox.checked ? customPrices[index - 1] * 1.4 : customPrices[index - 1];
    const total = qty * price;
    document.getElementById("totalPerSize" + index).textContent = "$" + formatPrice(total);
  }

  function formatPrice(price) {
    return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  function resetInputs() {
    document.querySelectorAll('.quantity-input').forEach((input, index) => {
      input.value = 0;
      lastAddedQuantities[index] = 0;
    });
    document.querySelectorAll('.total-per-size').forEach(el => el.textContent = "$0");
    interestCheckbox.checked = false;
    calculateTotal();
  }

  function updateLiveSummary() {
    sizes.forEach((s, i) => {
      const currentQty = parseInt(document.getElementById("quantity" + (i + 1)).value || 0);
      const alreadyAddedQty = lastAddedQuantities[i];
      const deltaQty = currentQty - alreadyAddedQty;

      if (deltaQty <= 0) return;

      const price = interestCheckbox.checked ? customPrices[i] * 1.4 : customPrices[i];
      const deltaTotal = deltaQty * price;

      const existingIndex = summaryData.findIndex(item => item.size === s.size);

      if (existingIndex >= 0) {
        summaryData[existingIndex].quantity += deltaQty;
        summaryData[existingIndex].total += deltaTotal;
      } else {
        summaryData.push({
          size: s.size,
          quantity: deltaQty,
          total: deltaTotal
        });
      }

      lastAddedQuantities[i] = currentQty;
    });

    reloadSummaryTable();
  }

  function reloadSummaryTable() {
    const tbody = document.querySelector("#recordTable tbody");
    tbody.innerHTML = "";
    summaryData.forEach(entry => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${entry.size}</td>
        <td>${entry.quantity}</td>
        <td>$${formatPrice(entry.total)}</td>
      `;
      tbody.appendChild(row);
    });
  }

function getTimeTag() {
  const hour = new Date().getHours();
  return hour < 12 ? "Mañana" : "Tarde";
}

async function downloadXLSX() {
  const workbook = new ExcelJS.Workbook();
  const sheet = workbook.addWorksheet("Resumen");

  // Header row
  sheet.addRow(["Tamaño", "Cantidad", "Total"]);

  // Data rows
  summaryData.forEach(entry => {
    sheet.addRow([
      entry.size,
      entry.quantity,
      formatPrice(entry.total)
    ]);
  });

  // Grand total
const grandTotal = summaryData.reduce((sum, e) => sum + e.total, 0);
const totalLabel = `Total: ${formatPrice(grandTotal)}`; // Includes space after colon
const totalRow = sheet.addRow(["", "", totalLabel]);

// Make the total cell bold
const lastRowNumber = sheet.rowCount;
sheet.getRow(lastRowNumber).getCell(3).font = { bold: true };

  // Style all cells
  sheet.columns.forEach(column => {
    column.alignment = { horizontal: "center", vertical: "middle" };
    column.width = 20;
  });

  // Bold header
  sheet.getRow(1).font = { bold: true };

  // Save the file
  const now = new Date();
  const dateStr = now.toISOString().split("T")[0];
  const timeTag = getTimeTag();
  const filename = `MC_${dateStr}_${timeTag}.xlsx`;

  const buffer = await workbook.xlsx.writeBuffer();
  saveAs(new Blob([buffer]), filename);

  // Format prices with $ and dot as thousand separator
  function formatPrice(value) {
    return `$${value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;
  }
}



</script>

</body>
</html>
